// SPDX-License-Identifier: AGPL-3.0

/*
  

  For some, One is done
  
  And governance, won...
 
      Next...
 
             take Two for you to do, 
   
  add Three with fees for me, 
        
                  for Four the floor,
            will pop off once more,
    
   Five should be free
   but I guess we shall see.
   
       all Six are required
          for the Seventhâ€”

                            a Royal decree!



  BGGGGGGGGGPGPPP5PPP5GGP55555YYYYJJJJJ????????77?777?JJ?777777777!!!!77!!!77777777777777J55J7777777777777777777777777???777??????????55Y??JJJJJJJYYYYYY
  GGPPPPPPPPPPP55Y5555PPP5Y55YJJJJ??????7777777777JYPP55PPY?!!!!!!!!!!!!!!!!!!!!!!!!!!777!!!!!!!!!!7J5PP5J7!7777777777777777777??7??Y55Y?????????JJJJJJJ
  PPP555P555555YYYYJYYY555YJJJJ????7?77777!!!7?Y5P5J7!~~^~?Y5Y?!~~~~~~!~~~~~!~~~!!!~~~!!!!!!!~~7?Y5PY?!!?Y5P5?7!!!!77!!777!!777777?JJ?777777777??????JJJ
  P5P5P5P5555555YJJJJJJYYYYYJ?7?7777!!!!!7JY5PY?!~^:::^:..::~!JY5J7~^^^^^^^^~^~~~~~~~~~~~^~!?Y55Y?!~~~^:::^~?Y55J7~~~~!!!!!!!!!!!77?7777777777777777????
  P5555YYYYYJJJJJJ?????JJJJ???7!7!!!~!7Y55Y?!^:.::::..::::.::::::!JYY?~^:^^^^^^^^^^^^^^^!J55J7~^^::::::..:::..:~7Y5Y7~^^^~~~~~~~!!!!!!!!!77777777777777?
  5555YYJJJJJ????????77777777?!!!!?Y55Y?!^:::::..::::..:^:........:::!JYJ7~^:^::::^~!?YYJ!^^^:..:::..:^^::::..:^^^^~!JYJ!~~^^~~~~!!!!!!!!!!!!!!!7!!77777
  5YYYYJJJJJ??JJJ?J???777777777YPP5?!~:::^:..:^:...:::.:^^^^^^:...:...::~?YY?!::~?YYY?!^:...:::::^^^!~^^:..::::.:::...^7Y55J7~^~~~~!7!!!77777777!7!!!!77
  YYYYYYYJJ??77??7?777777!!77!5@7!~^^^..:^^:..:^^^:^^~^^!?77?J?!::^:......:^7YBBJ7~^^:::::::~777????JYJ7~::..::::::^^^^^~~!?5PGJ~~~~!~~!!!!!!!!!!!!!!777
  JJJJJ??????7777777!!!!!!!!!!Y&7~::::^:^:::::^755~!77???JY55555Y!~~^::...:^~~&P^:..:::::^~!55YJ?77777?Y5J!:.:^:..:^^:.:::.:^!@5^^~~~~~~~~~~~!!!!!!!7777
  JJJJJJJJJ?J?????77777!!!!!~~Y&7~:.:^~~:..:^~~!55J??JY55555555555?~~~^::...^^&5^:::::::^^~55YYYYYJ??????JYYJ!~~^::~~:::::.:^!@J~~~!!!~~~~~~~~~~~~~!!777
  JJYJJJ????????????777!!!!!!!5&:::^~^^:::^^~??JJJJY55555555YYYYYJYJ7!^:::::^^&Y^::::..:^!PGP555Y5YYYYJJJJ??Y5PY?!!!~::.:^:::~@!^^^^~~~~~~~~~~~!!!!!!!!!
  JJ????????77777777!!!!!!!!!~5&:.:^^:..:^!YB#5YYYYY5YYYYJJPG5YYY557^^:.....::&5^:..::::^YBGGPPPP55555YYYJJJ???YPGY~^:..::...~@^^^^^^^^^^^^^^^~~!!!!!!!!
  JJJJJ???JJ??JJJJ?777!!!!!~~~P&^:::::::^75PYBP5YYYYYYYJJJ5GJ5BYJJJ~^^:::^:::^&Y^::::...^~J#BGGGPPP555555YY5PGGG#&&P~:....::.7&^^~~~~!!!!~~~~~~~~~~~!777
  JJ?JJ????????777!!!!!!!~~~~~P#......:~5G7YYJJPPJJJJJJJ5G7PY?#G5GJ~^...:^::::&J:...:::::^J&B&#GGGPPP55555##BGYGPPB&P~^:::::.J&::^^^^^^^^^~~~~~~~~~~~!!!
  YYJJJ????????77!!!!!77!!!!!~G&^:::::~!7G~!!7J?5PJJYY55GB??YP#&&G^^^:::^:...^&J::::^:::::J#P&#&#BGGGGPPG##5Y#B#PJPG&G!^~^:..5B::^^^^^^^^^~~!7!!~!!!!!~!
  J???????777777?7777~~~~~!~^^G#......^~~?G5J7~~^JP5Y?Y?P#G######G!^::.:^^:::~&7..::~^::::7PG#G#&G##BGGB##P7BGB##GYJB?^::::^^BG::::::^^~~~~^^^~~~~~~~~!7
  ????J??????7777!!!!!!!!!!~!~G#::::::^^~!5!~G#PYY5P55PBGJ5&#BG5Y?!^::.:::..:^&7:::^~~::::^^!YPB&5##&####?5GB##BP#!75~^::.:^~&5:^^^::::::::^^~~~~~~~^~!!
  JJJ?777777??777777!!!~~~~~~~B#~::.:..:^~?7!G#~~5##&B5GBB#GY7!::^^:...:::::^^&7:::^^:....:^^^~7YP#BBB#GB.J#YYGYY#!~?::::^^^!@J::::^^^^^^^:::::::::^::^^
  JJ????77!!~~~~~~~~~~~!!!!~~^B#!^::::::::::~7J7!YBB&#BBP?^::::...::......:^^^&!........:::..:^^:^?YG&GJB:J#Y5G5P#YJ!:....:^~@7.::::::::^^:::::::::::::^
  ??????7!!~~~^^:^^^^:^^~~~^^~##!~^^:..::..:::.:^~JY5?~^^:...::::^~^:..::::^^~G5~^::..:::::::::::::^~?Y5B~5B55YJ7!!~^:....::!@!::^:::::::::::::::::::::^
  ?77777~~~~~^^^:::::::::!?YP5J5GPJ~^::::...::..:^^^::...::^^~~^^^:::::^^^^!!5#&G7~~^^^:..:^:^::.:::..:~7~~^^:::::::::..::~~?BY?!^:::::::::::^^^^^^^^^^~
  JJ???7~^::^^^^^::::^^!JYY7^::^!7?Y5J7^::::::.::::.:::::^^^^^::::...^Y5755P5GG&&BPY?!:::::::.::^^::..:::..:....::..::^~!JY57^:!Y5J7^:::::^^::::::.:::::
  JJ???7^:::::::::^!?J?!:......::...^!JY?7!~:..:^^:..:~~::::....::^~?JG&Y~?55PB#&&B?7YJ?7~^:.:::::^:^~^^:.......:^^~~JGB5?~::..::~!JP5J~:..:::::::::::::
  ???7!!~:::..:~7J?7^........::....:::..^755?!^:^^::.::::..:::^^!Y5YJPB#P:~GGP##B#5:..:!JYYJ7~::..:^^::::...:::~!?PPPY???J?7~^::..:~!~7Y5Y7^:.:::::::^^:
  ??77!~~:^!?JJ7~:::::..:::..:^::::..:::::.:~JYJ?!^..::^^::^!J5Y?!~Y#PPPPY7JB5G###!^:^:.::^?55J7::::...:^^:^~?J55BGJY5~~JJJY5!^:.::~^:..:!?55?~:::::::^:
  7J???JY5Y?~:..:~!!77!!~^^~~!7?J7^::^~^^::..::^!YY?!~^:!YYJ7^::^!Y5##BBB#&BGGGB##~^~~^...:::^~J55?!^^:^!JYYJ?!!?PP5GB5YPJJYJ57^::::^:.:::^~!?YPY7^:.:::
  ~777##57^::::^^~^7JJJYY?J5J?!PBG5J!!?YY55?^::..:^?YGPYJ7~:..::~7J&##GPG##BPGPPGGPYYG?~^!^...::^~?YP5JJY7~:..!J7?JY5G55GYYY??J?^....:::::^~!~:^~?YYY7^^
  ~7??@G7~..::^~^:.:^!?YYJJP?J!PPPBB#PPGGGGPJ^^^::.:^P&~!^::..:!YYPBB5?Y##P5PBPY55PB#&B7YBP~::::::^^^Y&:.:::::~7YP55YJYYYY55YY7!^::.::::.:::::.....:7&!:
  !?JJ@5!^:::.::::.::^~75YJJYP?GPGGGPP5YJ?!^:^^^^:::^G#^~~?^::^^BB#B5J5B#GJJBPG?JYB#BG#BB###Y::..:!?^Y&.:..:^~^~?PPGGP55PP5GPG!~^...::^^::....:::::^!@!^
  ~7??@?:..:::::^:..:^!5BPY5GPP#GPPPB5^^~^^^:.:::::::GB^~?YY~^~~GP##GPPGGGY5GPPYJGBPB5PBGPPGB?^^^~P#?P#^^:..::^^~JP55J7??7?PP7~~::...:^::...:^::..:^7@~:
  ^~7J@J~:...:.::::::^~G#BGB#B#######?^~^:::::.::..::BB!!7YBP77?7PG#B55PBG5GPBBGPGPPBGGGGGB##J^~?PB#B#B^^::...:^~~BB5P5P55P5P!^::..:^~^^:...::^^:::^?@!~
  ^^^!@?~:...:::::^^~?J5P5Y5B&&B555G#~^^:...:^^::::::BG5P5GB&B#Y5GB###B5BB5GGBPYG#BGBGPBBBGPGPJJBG###@P^^::::^:^!!PB~?!!!^J?57^:...:^!~^::...::^:.:^7@~^
  !~~7@~:....:::!77JYYP5GGP#####PJJJPJ!~^~^:::::..::^#P!PY##G5P5Y5PG&&#BB&BP5B#5G&GP##BBP#BGG#BG#BGBP#5::..:::~7?JYBY5JJ?JYYP?^^^7!7~^!~^^:...:::.::7@^:
  ^^:!@^.....::~JGPYY5GG575BPY5YPBPYYY5J!!^^::....:^^#5^JY&BP55B55PP#BPP5BB7YBB#B&BG#&BBBG#BBB##&###J#Y:::::~!J??5Y555!G!!~^?P5?5YJJJJY5J5J^:^:^^:::?&^:
  ::.!@~:...:::~^7J!7#P555#BPPGBB##B5YYPB7^~^^:....:^&P~?J&#BGBGJPP#BPPGPGB55G#&#&#B##BBGG#BB#BGGGGGJ&J...::75YYYGPP5P~?!~?75GB5YYYJYJYGPJYJ!~^^:...?&^^
  :::7&~:....:^~~~^^~G#GG##BB5PB###B#BGG7!!::::....:^&5!YY#GGGGG5GG#GPPPPG#PJG#&##&BG##P##B&GG5P5GPG5&?::^^~?5P!^YG5G55GGGGBGPJJJJJJJYY5YYJ?J7~:...:J&::
  ^^:J&~^^:::::^^:::^?5B####BG#BG&&##&#7^^::.......::&Y7YJBPPGYYY5#BPGGGGG&YJBBBGGBGPBBG&GY###G5P55YJ&!:^!5PP55?!JPJYJ5P5GGGGGGG55YYYYYJ?J????!:....J&.:
  ^^:Y&~!:....:::...^^^JGPB#BG&B5#BBGBJ:~^:::......:^&J^!~^^~~7Y7YBP55P#G5#55GBPGPGBPBBGGG####P77^^^~@!^~~5BGGP5PG?^::::^~Y5Y5GG##BGJYP5J??7JJ^:..:.J&.:
  ^^:5&!^^^::..::...:^^:::^~~!!!7^^^^::::^^:..:..::^^&?^~~^:...:^!777JYPGYBY5GBGGBG5JY?~^^75B#B57~^:7@~^~~~^!7Y5PPJ.:::::::57~7JYPGB?P##B5577?::...:5#^^
  ~~^!P5Y7~^:...:....::........:^:..::........::::!?5#5?~^:::...:...:^!77JGJJG5?J?~:::::..:~75GGPJ^7P&J!~^^^^~~~75P7^::^^~7G5^^^^~7GYYPGP~YJ57:::.::G#^^
  !!!~~!7J5Y7^^^^::::::..:.:...............::^~!?YJ7~!!?JYJ~:::::...:^^::^~~^^::.::...:^^^^:^~!~7Y5J7~!?557!^^^:^7!!^^~!7!7JJ777JPYJJJJ5YYY?7^^~!7J557:^
  ^^~^^^^:^~7JYY7~:^^::...::::..::.....:.::~7Y5?~:..:?^..:~JYYJ~:::::..::..::::..::...:^~::^!J5Y7^:::...:!?55?7~:^^:..:::..:^~~!777!!?J7^^~^!7JYY?~^::^~
  ^~~^^^^^^^^^^~?YJ?~:::::..::....:...:!?YYJ7!?:^^:^7Y7:::::!7JY5Y7~^:::::...::..:::::::~7JY7~::...:::::::^^~J#GGY~~:^^:...:...::::::^^~^!JYY?~^:::^~~~~
  ~~~~~~~~^^^^^^:^!JY5J~^^^^^:::.:^^!JYJ?7~:~?GYJ?JJ5G#777!~YP^:~7Y5Y?!~^:...:::.::^!JJJ?!^:...:^:..::...:~??P#B###PJ!^::..::::^^::.:^7YJJ7~^^^~^^^^^^^^
  ~~~~~~~~^^^::::::..:^7YY?7~^^~~?YY7~:::^^^^Y##BJ!!!5BJ?J5PBB7^:...:!YPY7:::~~~~!?JJ7~:...::...::..^!!!7JPGB#BBBBBGYYPY7^...:^^~~7?J?!:.....::::^~~~~!!
  ~^^^^^^^^^^^^::::.:....:~JY55YJ7^~^:..::^~75B5GPBP7JB##B####J^::....:~?JP5J77JJ7~:..::...^^:^~!7JY5GBPPPPPGBBBBBBB!^~7J5Y?~~JYYJ7~:........::::^^^^~~~
  ~~~~^^^^~~~~~~^^^::::.:....&5:^:^^^^:..:::~BBBBGBGJY######&#7:^^::::..:^^~G&~:..:...:^~~!JJ55PPPPBPGP55PPPGBBBBBBB5!~^^^~7G#7~^:^^^^:::::::::::^^^^~~~
  ~~~~^^^^^^^^^^^^^::::::^:::&Y:...:^^::::^7?PJ?GJGBGB####B##YJ~^^::::::::^^5&::::~^^!5G5GGGGGGGGPPPPGGGPPBGGGGBBBBBBP!~^^^:P#.::::::::::::::.:^^^~~~^^^
  ~^~~~^^^~^^^^^^^^^^::^:::::&Y^:::^^:::^~!PGP?~77Y??GBGBPGGGPBPJ!:..:^~:...J&~!!~?JY5YP5PPPPPGGGGGGGBGP5PBGPPPGBBGPB?~:..::5B.::::::::::.....:::^^^~~~~
  ~^~~^^^^~~~^~~~~~~~~^::^^^:&Y::.::::..:~5###BP5JJ??G#GGGGBB###B?^::::^^:::Y&^~7YYPBG!^75PGGBBBBGBGGPPGPPYYB#PYJ??7P~^:....PB.:::::^^^^^::^:::^^^^^~~~~
  ~!!!~^^^^~~~~^^^^^^^^^^^^^^&Y^:::^~^:::~~G#BGBB##B5G#########B~^^:..:^::::5#~!JYYJGG57GPGBGGGGGPGG5PP5GB#7G&?7?7?7~^:..:::GB.:::::^:::::^^^^~^^~^^^^^^
  !!!~~^^^^~~^^^^^^^^^~~~~^^^&J^:::^~^:..:~B&57BGYYPPG##BBGGBG#B~::..::^::::P#^~~!Y?GPYJG?GPPPPG5PP55BJ!###Y5P77!~~^::::....PG.:::::::::^^^^~!~~~~~~~~~~
  ~~~~!~~~~~~~^~~~~~~^^^^^^^^&Y::..^~^:::^!##JJJ5JJ7YG#GP55PPP##?^:....:::::P&~^~!J5BBY~PYGJ!BJJ?JJJ5GPJPY7!!~^~~^^:..::::::GG::^^^^:^~~~~~^^^^~~~~~~~!!
  ~~~~~~~~~~~~^^^^^^^^^~~~~~~&J::::^^:..^!YBGJJ?J75Y5B&GPPGP5PG#P!!^:::::...P#^::::^^^::~~?!^G!?PP5PPPPGPJ7~!~::..:::^^~~::.GG:^^^^^^^^^^^^^~~~~~~!!~~!!
  777!~~~~~~!!!!~~~~^^^^^^^^^&?...:^^:::~GGGG5?JJ?GGPB&#G##G55PG#B7^:.:^::::PB......::..:?YYYBG#BBGPPGP5GBBP~^^..:^^:^^^^:..BG:^^^^~~~~!!~~~~~~~~~~~~~~~
  77!7!7!!!!~~~~^~~~~~~~~~~^~&?^:^::..:~7B&#&#J?J?GBPGBGB&####&#GJ^::..::...PB^^::::::^!JGBGGPGBB##BGP5PPPBB5^...:::..:::::^#G^^^^^^^^^~~~~!!~~!!~~~~~~!
  !!!!777777!!!~~~~~~^^~~~~~!@7..:::::^~~!!?5G5YJ?B&B##&&&BPYJ?!^....::...::G#~^:.....^7PPBBPGGBB##BGPP5YYYPG5!^^:...:::..:^#G~!!!~~~~^^~~~~~!~~!!!!!!!7
  !!!!!!!!!!!!!!~~~~~~~~~~~~!@?:::....:^:..:~~!77?PPP##BPY!^:...:::::^^::.::BB^~~^::..:~!?PBBGGBB#BBGPYGB###P5#J!~^^^^:..:~!#P^~~~~~~~~~~~~~~!!!!!!77777
  ???7?7!!!!!7777!!!~~~~~^^^!&P7~::..::^:::^::.:~!!~!77!^:::::...:^^::::.:^!##!~~!~^^::~7^~JGPBPGPBBGYGBGGBBBJY7777~^:::^~~!&P~~~~!7777!!777!!!!!!!!!!!!
  ?7777!!!!!!!!~~~~~~!!!~!!~~~?5PY?!~:...^~~::::^^:::^^^:....:^:::^:..:~?5PY?J55JJ7^:..:!7~~P??Y5YJ5GGPJPPPGGBY~^~~^...^7J5PB?~!!!!!!!!!!!77777??7777777
  7??7!!!!!!!!!!!~~!!!!~~~~~~!!!!?5PP?~^:::::^~^:.......::^:::^:..:~?Y55J7!~~~~!?YPY7^::::^!J?7????YYJJ!GGG5YJ!^..:^~!?5P5Y7~!!!777!7!!!!7777777?77?????
  ??7777777!!7777777777777!!!!!!!!~~7YPPY!:.:^::::^^^^::^~!~:.:^7Y55Y7!!~!!~!!!~~~!7Y55J^:.:^:::~~^^~!~!7?!:..:^^^75PPY?!!7777777?????????????????????JJ
  JJJJ?????777777777??7777777777777777!7J5P5Y7^.:^^::^~^:.:~!7JYYJ7!!77777777777!77777?J555J~:.:~:..:~:..:^^:^?PGP5J77777??JJ??JJ?JJ??JJJJJJJJJJJJJJJY5P
  55YY5J???????????JJ???JJ?JJJJJJJJJJJ????JYPGG5J?~:::~~~7JPPY???JJJJJJJJJJJ??????????????J5GP5Y?7~~!7!^^!JPGGPYJJJJJJJJJJJJJYYJJYYYYYYYYYY55555YYY5PGG#
  55G55YYYYYY5YYYYY5YYYYY55YYYY5Y5555YYYY55Y5Y5GB#PJ?JGBGPYYYYY555Y5555555YYYYYYYYYYYY5YYYYYY5PB#GYYYYY5GBGP5YYY555YYYYYYYY555555555555555PPP5PPPPPPBB#&

*/
  
pragma solidity ^0.8.0;

library Base64 {
    bytes internal constant TABLE =
        'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';

    /// @notice Encodes some bytes to the base64 representation
    function encode(bytes memory data) internal pure returns (string memory) {
        uint256 len = data.length;
        if (len == 0) return '';

        // multiply by 4/3 rounded up
        uint256 encodedLen = 4 * ((len + 2) / 3);

        // Add some extra buffer at the end
        bytes memory result = new bytes(encodedLen + 32);

        bytes memory table = TABLE;

        assembly {
            let tablePtr := add(table, 1)
            let resultPtr := add(result, 32)

            for {
                let i := 0
            } lt(i, len) {

            } {
                i := add(i, 3)
                let input := and(mload(add(data, i)), 0xffffff)

                let out := mload(add(tablePtr, and(shr(18, input), 0x3F)))
                out := shl(8, out)
                out := add(
                    out,
                    and(mload(add(tablePtr, and(shr(12, input), 0x3F))), 0xFF)
                )
                out := shl(8, out)
                out := add(
                    out,
                    and(mload(add(tablePtr, and(shr(6, input), 0x3F))), 0xFF)
                )
                out := shl(8, out)
                out := add(
                    out,
                    and(mload(add(tablePtr, and(input, 0x3F))), 0xFF)
                )
                out := shl(224, out)

                mstore(resultPtr, out)

                resultPtr := add(resultPtr, 4)
            }

            switch mod(len, 3)
            case 1 {
                mstore(sub(resultPtr, 2), shl(240, 0x3d3d))
            }
            case 2 {
                mstore(sub(resultPtr, 1), shl(248, 0x3d))
            }

            mstore(result, encodedLen)
        }

        return string(result);
    }
}


interface ERC721 {
  event Transfer(address indexed _from, address indexed _to, uint256 indexed _tokenId);
  event Approval(address indexed _owner, address indexed _approved, uint256 indexed _tokenId);
  event ApprovalForAll(address indexed _owner, address indexed _operator, bool _approved);

  function balanceOf(address _owner) external view returns (uint256);
  function ownerOf(uint256 _tokenId) external view returns (address);
  function tokenOfOwnerByIndex(address owner, uint256 index) external view returns (uint256);

  function safeTransferFrom(address _from, address _to, uint256 _tokenId, bytes memory data) external payable;
  function safeTransferFrom(address _from, address _to, uint256 _tokenId) external payable;
  function transferFrom(address _from, address _to, uint256 _tokenId) external payable;
  function approve(address _approved, uint256 _tokenId) external payable;
  function setApprovalForAll(address _operator, bool _approved) external;
  function getApproved(uint256 _tokenId) external view returns (address);
  function isApprovedForAll(address _owner, address _operator) external view returns (bool);
  
  function name() external view returns (string memory _name);
  function symbol() external view returns (string memory _symbol);
  function tokenURI(uint256 _tokenId) external view returns (string memory);
  function totalSupply() external view returns (uint256);
}

interface ERC165 {
  function supportsInterface(bytes4 interfaceID) external view returns (bool);
}

contract IStatusRenderer {
  function renderStatus(
    string memory _kingdomStatus,
    uint256 _generation,
    string memory _img,
    string memory name
  ) public view virtual returns (string memory) {}
}


contract StatusRenderer is IStatusRenderer{
  string public logo;
  address public _admin;
  constructor(string memory _logo) {
    logo = _logo;
    _admin = msg.sender;
  }

  function setLogo(string memory _logo) external {
    require(msg.sender == _admin, "Renderer: Only admin can change the logo");
    logo = _logo;
  } 

  function renderStatus(
    string memory _kingdomStatus,
    uint256 _generation,
    string memory _img,
    string memory name
  ) public view override returns (string memory) {
    
    return string(abi.encodePacked(_buildPartOne(_img),_buildPartTwo(name, _kingdomStatus, _generation),_buildPartThree(logo)));
  }

  /// @notice Converts an integer to a string
  /// @param  _i The integer to convert
  /// @return The string representation of the integer
  function _integerToString(uint _i) internal pure returns (string memory) {
    
    if (_i == 0) {
      return "0";
    }
   
    uint j = _i;
    uint len;
    while (j != 0) {
      len++;
      j /= 10;
    }
    bytes memory bstr = new bytes(len);
    uint k = len;
    while (_i != 0) {
      k = k-1;
      uint8 temp = (48 + uint8(_i - _i / 10 * 10));
      bytes1 b1 = bytes1(temp);
      bstr[k] = b1;
      _i /= 10;
    }
    return string(bstr);
  }


  /// @notice Build the badge SVG in parts because otherwise it causes stack too deep errors
  function _buildPartOne(string memory img) internal pure returns (string memory) {
    return string(abi.encodePacked("<svg width='549' height='507' viewBox='0 0 549 507' fill='none' xmlns='http://www.w3.org/2000/svg'  xmlns:xlink='http://www.w3.org/1999/xlink'>  <rect width='549' height='507' fill='#2C2C2C' />  <g>    <rect width='549' height='507' fill='black' />    <g>      <rect x='100' y='48' width='350' height='393' rx='30' fill='#161616' />      <rect x='100' y='48' width='350' height='393' rx='30' fill='url(#paint1504_radial_0_1)' fill-opacity='0.2' />      <rect x='100' y='48' width='350' height='393' rx='30' fill='url(#paint1505_radial_0_1)' fill-opacity='0.2' />      <g>        <rect width='325' height='247' rx='21' transform='matrix(1 0 0 -1 113 307)' fill='white' fill-opacity='0.06' />        <rect x='-0.75' y='0.75' width='326.5' height='248.5' rx='21.75' transform='matrix(1 0 0 -1 113 308.5)' stroke='white' stroke-opacity='0.1' stroke-width='1.5' />      </g>      <rect x='390' y='375' width='42' height='50' fill='url(#pattern0)' />      <path        d='M136.768 399.534C136.526 398.822 135.474 398.822 135.233 399.534L134.369 402.076C134.317 402.231 134.214 402.366 134.076 402.462C133.939 402.558 133.773 402.609 133.603 402.609H130.809C130.026 402.609 129.702 403.567 130.334 404.008L132.594 405.579C132.732 405.675 132.835 405.81 132.887 405.965C132.94 406.12 132.94 406.287 132.888 406.442L132.024 408.985C131.782 409.697 132.633 410.289 133.267 409.849L135.527 408.278C135.665 408.182 135.831 408.13 136.001 408.13C136.171 408.13 136.337 408.182 136.475 408.278L138.735 409.849C139.368 410.289 140.218 409.697 139.977 408.985L139.113 406.442C139.061 406.287 139.061 406.12 139.114 405.965C139.166 405.81 139.269 405.675 139.407 405.579L141.666 404.008C142.298 403.568 141.973 402.61 141.192 402.61H138.398C138.228 402.61 138.062 402.559 137.924 402.463C137.786 402.367 137.684 402.232 137.631 402.077L136.767 399.534L136.768 399.534Z'        fill='#F1952A' />            <path opacity='0.1' d='M113 272H438' stroke='white' />            <g>        <foreignObject x='114' y='60' width='324' height='324'>          <img xmlns='http://www.w3.org/1999/xhtml' src='", img));
  }
  function _buildPartTwo(string memory _name, string memory _status, uint256 _generation) internal pure returns (string memory) {
    return string(abi.encodePacked("' style='margin-left: auto; margin-right: auto; border-radius: 7%; width: 100%; height: auto; object-fit: cover;'></img>        </foreignObject>        <text x='130' y='342' fill='#808080' font-size='14px' font-weight='300' font-family='arial'>", _name, "</text>        <text x='130' y='378' fill='#ffffff' font-size='30px' font-weight='500' font-family='arial'>", _status, "</text>        <text x='147' y='410' fill='#808080' font-size='14px' font-weight='300' font-family='arial'> Gen. ", _integerToString(_generation), "</text>      </g>    </g>  </g>"));
  }
  function _buildPartThree(string memory _logo) internal pure returns (string memory) {
    return string(abi.encodePacked("<defs>    <filter id='filter0_b_0_1' x='17.5' y='-35.5' width='516' height='438' filterUnits='userSpaceOnUse'      color-interpolation-filters='sRGB'>      <feFlood flood-opacity='0' result='BackgroundImageFix' />      <feGaussianBlur in='BackgroundImage' stdDeviation='47' />      <feComposite in2='SourceAlpha' operator='in' result='effect1_backgroundBlur_0_1' />      <feBlend mode='normal' in='SourceGraphic' in2='effect1_backgroundBlur_0_1' result='shape' />    </filter>    <pattern id='pattern0' patternContentUnits='objectBoundingBox' width='1' height='1'>      <use xlink:href='#image0_0_1' transform='scale(0.000454545)' />    </pattern>    <pattern id='pattern1' patternContentUnits='objectBoundingBox' width='1' height='1'>      <use xlink:href='#image1_0_1' transform='scale(0.0025)' />    </pattern>    <radialGradient id='paint1504_radial_0_1' cx='0' cy='0' r='1' gradientUnits='userSpaceOnUse'      gradientTransform='translate(388.5 376) rotate(-107.149) scale(225.527 188.328)'>      <stop stop-color='#CEFF00' stop-opacity='0.35' />      <stop offset='1' stop-color='#CEFF00' stop-opacity='0' />    </radialGradient>    <radialGradient id='paint1505_radial_0_1' cx='0' cy='0' r='1' gradientUnits='userSpaceOnUse'      gradientTransform='translate(264 173.5) rotate(106.601) scale(306.265 272.755)'>      <stop stop-color='white' stop-opacity='0.49' />      <stop offset='1' stop-color='white' stop-opacity='0' />    </radialGradient>    <image id='image0_0_1' href='", _logo, "' width='2200' height='2200'></image>  </defs></svg>"));
  }

}

contract KingdomSoulBoundTokens is ERC721 {

  string public   name;
  string public   symbol;
  uint256 public  totalSupply;
  address private _admin;
  address private _rendererAddress;
  
  struct StatusMetadata {
    string _status;
    uint256 _generation;
    string _img;
    
  }

  mapping(uint256 => address) private _ownership;
  mapping(address => uint256[]) private _ownedTokens;

  
  mapping(uint256 => StatusMetadata) public status;
  

  constructor(
    string memory _name,
    string memory _symbol, 
    address _renderer
  ) {
    name = _name;
    totalSupply = 0;
    symbol = _symbol;
    _admin = msg.sender;
    _rendererAddress = _renderer;
  }
  
  /// @return True if minted
  function mint(
    address _to,
    string memory _status,
    uint256 _generation,
    string memory _img
  ) public returns (bool) {
    require(msg.sender == _admin, ": Only the admin can mint new tokens");
    require(_to != address(0), ": Cannot mint to the null address");

    StatusMetadata memory _statusMetadata = StatusMetadata(
        _status,
        _generation,
        _img
    );
    totalSupply += 1;
    _ownership[totalSupply] = _to;
    _ownedTokens[_to].push(totalSupply);
    status[totalSupply] = _statusMetadata;

    emit Transfer(address(0), _to, totalSupply);

    return true;
  }

  function changeRenderer(address _newRenderer)public {
    require(msg.sender == _admin, ": Only the admin can change the renderer address");
    require(_newRenderer != address(0), ": Cannot change to the null address");
    _rendererAddress = _newRenderer;
  }

  function changeAdmin(address _newAdmin) external {
    require(_admin == msg.sender, "ADMIN: Only Admins can call this function");
    _admin = _newAdmin;
  }

  function tokenURI(uint256 _tokenId) public override view virtual returns (string memory) {
    require(_ownership[_tokenId] != address(0x0), ": token doesn't exist.");
    
    StatusMetadata memory _status = status[_tokenId];
    string memory jsonName;
    {
        jsonName = string(abi.encodePacked(
            '"', _status._status, ' | ', name, '( #v', _integerToString(_status._generation) ,' )"'
        ));
    }
    string memory svg;
    {
      IStatusRenderer renderer = IStatusRenderer(_rendererAddress);
      svg = renderer.renderStatus(
        _status._status,
        _status._generation,
        _status._img,
        name
      );
    }
    string memory json = Base64.encode(bytes(string(abi.encodePacked(
      '{',
      '"name": ', jsonName,  ',',
      '"description": "A shiny, non-transferrable badge",',
      '"tokenId": ',_integerToString(_tokenId),',',
      '"image": "data:image/svg+xml;base64,',Base64.encode(bytes(svg)),'"',
      '}'
      ))));

    return string(abi.encodePacked('data:application/json;base64,', json));
  }

  function balanceOf(address _owner) public view virtual override returns (uint256) {
    return _ownedTokens[_owner].length;
  }

  function ownerOf(uint256 _tokenId) public view virtual override returns (address) {
    return _ownership[_tokenId];
  }

  function tokenOfOwnerByIndex(address owner, uint256 index) public view virtual override returns (uint256) {
    require(index < balanceOf(owner), "ERC721Enumerable: owner index out of bounds");
    return _ownedTokens[owner][index];
  }

  

  // this function is disabled since we don;t want to allow transfers
  function safeTransferFrom(address _from, address _to, uint256 _tokenId) public payable virtual override {
    revert(": Transfer not supported.");
  }
  
  // this function is disabled since we don;t want to allow transfers
  function safeTransferFrom(address _from, address _to, uint256 _tokenId, bytes memory _data) public payable virtual override {
    revert(": Transfer not supported.");
  }

  // this function is disabled since we don;t want to allow transfers
  function transferFrom(address _from, address _to, uint256 _tokenId) public payable virtual override {
    revert(": Transfer not supported.");
  }

  // this function is disabled since we don;t want to allow transfers
  function approve(address _to, uint256 _tokenId) public payable virtual override {
    revert(": Approval not supported.");
  }

  // this function is disabled since we don;t want to allow transfers
  function setApprovalForAll(address _operator, bool _approved) public virtual override {
    revert(": Approval not supported.");
  }

  // this function is disabled since we don;t want to allow transfers
  function getApproved(uint256 _tokenId) public view override returns (address) {
    return address(0x0);
  }

  // this function is disabled since we don;t want to allow transfers
  function isApprovedForAll(address _owner, address _operator) public view override returns (bool){
    return false;
  }

  function supportsInterface(bytes4 interfaceId) public view virtual returns (bool) {
    return
      interfaceId == 0x01ffc9a7 ||
      interfaceId == 0x80ac58cd ||
      interfaceId == 0x5b5e139f;
  }


  /// @notice Converts an integer to a string
  /// @param  _i The integer to convert
  /// @return The string representation of the integer
  function _integerToString(uint _i) internal pure returns (string memory) {
    
    if (_i == 0) {
      return "0";
    }
   
    uint j = _i;
    uint len;
    while (j != 0) {
      len++;
      j /= 10;
    }
    bytes memory bstr = new bytes(len);
    uint k = len;
    while (_i != 0) {
      k = k-1;
      uint8 temp = (48 + uint8(_i - _i / 10 * 10));
      bytes1 b1 = bytes1(temp);
      bstr[k] = b1;
      _i /= 10;
    }
    return string(bstr);
  }
}